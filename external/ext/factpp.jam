# "owl_cpp/external/ext/factpp.jam"
# part of owl_cpp project.
# Distributed under the Boost Software License, Version 1.0; see doc/license.txt.
# Copyright Mikhail K Levin 2010-1

# Boost.build script for building FaCT++ library 
# <http://code.google.com/p/factplusplus/>

import extension ;

import property ;
import project ;
import feature ;
import common ;
import regex ;
import path ;
import utils ; #local jam-file

extension.declare factpp ;

rule factpp_kernel_config_hpp ( targets * : sources * : properties * ) {
   STR on $(<) =
      "#ifndef FACT_KERNEL_CONFIG_HPP"
      "#define FACT_KERNEL_CONFIG_HPP"
      ""
      "#include \"boost/config.hpp\""
      "#ifndef BOOST_SYMBOL_EXPORT"
      "  #define BOOST_SYMBOL_EXPORT"
      "  #define BOOST_SYMBOL_IMPORT"
      "#endif"
      "#if defined(FACTPP_KERNEL_DYN_LINK)"
      "#  if defined(FACTPP_KERNEL_SOURCE)"
      "#     define FACTPP_KERNEL_DECL BOOST_SYMBOL_EXPORT"
      "#  else"
      "#     define FACTPP_KERNEL_DECL BOOST_SYMBOL_IMPORT"
      "#  endif"
      "#else"
      "#  define FACTPP_KERNEL_DECL"
      "#endif"
      ""
      "#endif /* FACT_KERNEL_CONFIG_HPP */"
   ;
   
   NL on $(<) = "
" ;
}
actions factpp_kernel_config_hpp { @($(STDOUT):E=$(STR:J=$(NL))$(NL)) > "$(<)" }

rule Kernel_h ( targets * : sources * : properties * ) {
   ## insert symbol visibility declaration
   local str = "#define KERNEL_H

#include \"factpp_kernel_config.hpp\"
class FACTPP_KERNEL_DECL ReasoningKernel;"
;

   local kern_h = [ utils.read_file $(sources:G=) ] ;
   kern_h = [ regex.replace $(kern_h) "#define KERNEL_H" $(str) ] ;
#   exit $(targets);
#   exit [ path.native $(targets) ] ;
   STR on $(<) = $(kern_h) ;
}
actions Kernel_h { @($(STDOUT):E=$(STR)) > "$(<)" }

rule init ( version ? : location : options * )
{
   version ?= default ;
   
   local kernel_location = [ path.join $(location) src/Kernel ] ;
   
   local requirements = 
      [ extension.define factpp $(version)
         : $(kernel_location)
         : $(options)
      ]
#      <dependency>factpp_kernel_config.hpp
#      <implicit-dependency>factpp_kernel_config.hpp
#      <dependency>headers
#      <implicit-dependency>kernel_h
      <include>$(BOOST[0])
      <include>$(kernel_location)
      <define>FACTPP_KERNEL_SOURCE
      <link>shared:<define>FACTPP_KERNEL_DYN_LINK
   ;
   
   make factpp_kernel_config.hpp 
      : 
      : @factpp_kernel_config_hpp
      : <factpp-version>$(version)
        <location-prefix>src
   ;

   make Kernel.h 
      : $(kernel_location)/Kernel.h
      : @Kernel_h
      : <factpp-version>$(version)
        <location-prefix>src
   ;
   
#   install headers : Kernel.h factpp_kernel_config.hpp : <location>$(OUT)/include ;
   
   local src = 
      [ glob $(kernel_location)/*.cpp : $(kernel_location)/parseTime.cpp ] 
   ;
   src += 
#      $(kernel_location)/Kernel.cpp 
   ;
   lib factpp_kernel
      :   $(src)
      :   $(requirements)
         <toolset>msvc:<link>static
#         <toolset>gcc:<cflags>"-fvisibility=hidden -fvisibility-inlines-hidden"
#         <toolset>gcc:<linkflags>"-fvisibility=hidden -fvisibility-inlines-hidden"
#         <toolset>gcc:<cflags>"-include\"$(OUT)/include/factpp_kernel_config.hpp\""
      :   
      :   
         <include>$(kernel_location)
      ;
}
